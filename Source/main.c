#include "mainconfig.h"
#include "mygpio.h"
#include "myiwdg.h"
#include "ssec.h"
#include "mysettings.h"

// Связь между проигрывающей и записывающей частями
// 
int16_t push[100];  // Времена импульсов
int16_t pnum1=0;    // Число импульсов в массиве
int16_t start_sound=0; // Флаг что нужно проиграть массив



int16_t ch=0;
int16_t timeon =0;

uint32_t ontime1=0;
	uint32_t ontime2=0;
  uint32_t ledst=0;
	uint32_t timeres=0;
	
 int16_t ot = 0;
 int16_t fire;
 int16_t off;
 int16_t action;
 int16_t action_time =0;
 int16_t pnum2=0;
 
 int16_t playsound=0;
 
 int16_t open = 3;
 
 int16_t button1_flag = 0;
 int16_t button2_flag = 0;
 
void beep(){
	if (start_sound==1) {
		pnum2=0;
		start_sound=0;
		playsound=1;
		action_time=getssec();
		Sound(1);
	}
	
	if (playsound) {
		if (tdlt(action_time)>=push[pnum2]) {
			pnum2++;
			if (pnum2<pnum1) {
				action_time=getssec();
				if (pnum2&1) Sound(0); else Sound(1);
			} else {
				playsound=0;
				Sound(0);
			}
		}
	}
	
//	if (start_sound==1){  // При таком подходе функция выполнится только один раз
/*	if (playsound) {	
		if (pnum2<=pnum1){
				action_time=getssec();
				if (pnum2%2==0){
					if(tdlt(action_time)>push[pnum2]){
						pnum2++;
						Sound(0);
					}
					
						
				}
				else{
					if(tdlt(action_time)>push[pnum2]){
						pnum2++;
						Sound(1);
					}
				}
		}
		else{
			pnum2=0;
		}
	}*/
}


// Переменные функции записи данных
int16_t pnum=0;  // Число записанных элементов
int16_t onb=0;   // Флаг нажатой кнопки
int16_t starton=0; // Флаг отжатой кнопки

//function for mass and push
void buttonpush() {
	if (!GGetPin(BUTTON)) {
      onb=1;
//			Sound(1);
			if (starton==0) {  // Сюда попадаем, если кнопку только что нажали				
				ontime1=getssec();
				starton=1;
				if(tdlt(ontime2)<20) return; //исключаем дребезг
				if (pnum){
					push[pnum]=tdlt(ontime2);
					pnum++;
//				}	else {
//					start_sound=1;
//					pnum1=pnum;
//					pnum=0;
				}
			}
  } else {
      if (onb==1) { //Сюда попадаем, если кнопку только что отпустили 
				onb=0;
//				Sound(0);
				if(pnum>99){
					pnum=0;
				} else{
					push[pnum]=tdlt(ontime1);
					pnum++;
				}
				starton=0;
				ontime2=getssec();
			} else {
// Сюда попадаем, если кнопку уже давно отпустили
        if (ontime2&&(tdlt(ontime2)>1000)) {
					start_sound=1;
					ontime2=0;
					pnum1=pnum;
					pnum=0;
				}
			}
	}
}

void handle_button1(){
	/*
	нажимаем кнопку
	если кнопку нажали то мы запоминаем время
	если кнопку отжали и дребега нет, то мы открываем дверь
	*/
	int16_t k = !GGetPin(KEYOPEN);
	if (k) { //нажата
		if (!lk){
			//если нет пред. 
			time3 = getssec();
		}
	}
	else { //не нажата
		if(1){
			if(tdlt(time3)>20){
				open = 1;
			}
		}
	}
	lk=k; //устанавливаем пред. значение
}

void handle_button2(){
	int16_t time3=getssec();
	if(time3<20) return;
	open = 2;
}

void opendoor() {
	int16_t openlocal;
	int16_t time1;
	int16_t status;
	int8_t flag = 0;
  if(((open != openlocal) && !flag) || (status == 1)) { //Открытие/Закрытие обычное
		status = 1;
		flag = 1;
		openlocal = open;
		if(openlocal == 1) {
			time1 = getssec();
			if(tdlt(time1) < 5000) {
			  GSetPin(RELAYOPEN);  	
			}
			else {
				flag = 0;
				openlocal = 3;
				status = 2;
			}
		}
		if(openlocal == 2) {
			time1 = getssec();
			if(tdlt(time1) < 5000) {
			  GSetPin(RELAYCLOSE);  	
			}
			else {
				flag = 0;
				openlocal = 3;
				status = 2;
			}
		}
		if(openlocal == 3) {
			flag = 0;
			openlocal = 3;
			status = 2;
		}
	}
	if((open != openlocal) || (status == 3)) {  //Открытие/Закрытие если передумал
		status = 3;
		openlocal = open;
		if(openlocal == 1) {
			if(tdlt(time1) < 5000) {
			  GSetPin(RELAYOPEN);  	
			}
			else {
				flag = 0;
				openlocal = 3;
				status = 2;
			}
		}
		if(openlocal == 2) {
			if(tdlt(time1) < 5000) {
			  GSetPin(RELAYCLOSE);  	
			}
			else {
				flag = 0;
				openlocal = 3;
				status = 2;
			}
		}
		if(openlocal == 3) {
			flag = 0;
			openlocal = 3;
			status = 2;
		}
	}
}
 

// ???????? ?? 16??? ?? ??????????? RC ??????????. ???????? ??????? -3.8..+5.5% ?? ???? ????????? ??????????
// ????????!!! ?????? ???????? RCC->CR
void SysInit(void) {
  RCC->CR |= 0x00000001;     // ???????? HSI
  while (!(RCC->CR&0x02));  // ??????? HSI (?? ?????? ??????)
// ???????? ?? ??????
  RCC->CR &= 0x0000FFF8;
  RCC->CFGR=0;  // ????????? ?? HSI ? ??? ???????????? - ?? ????
// ????????? PLL - ???????? ????? ?? 16 ???
  RCC->CFGR2=1;  // ? ??? ????? ???????????? ????? PLL
  RCC->CFGR3=0;
  RCC->CFGR|=0x00080000;  // ????? ?? 2, ???????? ?? 4, ???????? - HSI
  RCC->CR |= 0x01000000;  // ????????? PLL
  while (!RCC->CR&0x02000000);        // ??????? ????????? PLL. ???? ?? ????????? - ?????????? ?????? ??? ????????
  FLASH->ACR = 0x00000010;  // Enable Prefetch Buffer and set Flash Latency
  RCC->CFGR|=0x00000002;    // ???????? PLL ??? ???????? ????????????
  while (!((RCC->CFGR&0x0C)==(0x02<<2)));  // ??????? ?????????????
// 
  RCC->CIR = 0x00000000;    // ????????? ??? ??????????
}

void ConfigHW() {
// ??????? ?????????? ? ???? ??? ?????, ????? ??? ????? ????????????
  RCC->AHBENR|=RCC_AHBENR_GPIOAEN|RCC_AHBENR_GPIOBEN|RCC_AHBENR_GPIOCEN|RCC_AHBENR_GPIODEN|RCC_AHBENR_GPIOFEN;
  RCC->APB1ENR|=RCC_APB1ENR_TIM3EN;     // ?????? ?????????? ????????? ??????????? 1?? ? ???????????? - ???????? UART
  RCC->APB2ENR|=RCC_APB2ENR_SYSCFGCOMPEN;// ????????? ??????? (???? ??? ???????? ?? ?????)
// ?????? ??????????? ??????  
// ??????
// 
// ??????
  GSetPinToOutput(RELAYOPEN,0,0);
  GSetPinToOutput(RELAYCLOSE,0,0);  
  GSetPinToOutput(MAINLED,1,0);
  GSetPinToOutput(SOUND,0,0);
// ?????
  GSetPinToInput(KEYOPEN,GPIO_PULLUP);
  GSetPinToInput(KEYCLOSE,GPIO_PULLUP);
  GSetPinToInput(PROGSW,GPIO_PULLUP);
  GSetPinToInput(BUTTON,0);
// ?? ???????????? ??????
  GSetPinToInput(GPIOA,0,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,1,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,2,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,3,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,4,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,5,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,11,GPIO_PULLDOWN);
  GSetPinToInput(GPIOA,12,GPIO_PULLDOWN);
  GSetPinToInput(GPIOB,5,GPIO_PULLDOWN);
  GSetPinToInput(GPIOB,7,GPIO_PULLDOWN);
// ?????? ????????? SSEC
  InitSSEC();
  __enable_irq();
}

////////////////////////////////////////////////////////////
// ???????? ?????????
// ??? ??????? ??????? ?? ?????????????, ?????? ??? ???????? ?????? - ?? ? ???????????
int main() {	
////////////////////////////////////////////////////
// ????????????? ?????????? ????? ???????????  
  SysInit();   // ????????? ?????????? ?? ?????? ??? ??????? (?????? - 16???)
#ifndef MYDEBUG
  InitIWDG(4);
#endif
  ConfigHW();  // ????????????? ?????????? ????? ??????????? (??????)
// ????????? ???????????? ?? ?????? ???????????. ?? ????? ???? ?????????? ?????? ??????????? ???? ? ?????????
// ?? ? ??????????? ??? ???? ????? ??????????? ??????. ???? ?????-?? ?? ????? ?????????? - ??????????? ????????? ??????????????.
  ReinitFromHardDSt(0);
// ????????? ?????????????? - 
// ???? ??? ???? ?????? - ???? ?????? ? ??????
// ????? ??????? - ????????? ? ?????? ????????? ??????? ???????? ??????, ? ????? ????????? ??????????? ????? ??????
  while (hssavetime!=0) {
    CLRWDT();
    CheckSaveHardDSt();
  }
// ????? ??????? ????? ???????? ????????? ?????????????, ??? ???? ???? ??????? ??????????? ????? ????????? ? ?????? ?????? ??????
// ??? ????????? ????????? ????????????? ????????????? ??? ????? (???? ???????? ?????? ?????, ? ?????????? - ??????), ???? ?????? 
// (???? ?????? ?????????? ??? ?????? ?????? ?????) ????? ??????.
//
// ????????????? ????? ? ?? - ?????? ????? ????????????? ?????? ?????? ?????????
// ????????? ????????? ????? ?????? ????????? - 115200 ???, 8N1 - ?? ???? 115200 ??? ? ??????? ??????????,
// 8 ??? ?? ???? ????? ??????, ??? ???????? ????????, 1 ???????? ???.
// ?????????? ???????? ???? - ?? ???? ????????? ??????? ?? ???????
  for (;;) {  
// ????????? - ???? ????, ?????????? ???????????????? ?????? ? ??????     
    CheckSaveHardDSt();
// ???????? ????????? - ?????? ??? ????????????????
//
		
 
buttonpush();
handle_button1();
handle_button2();
beep();
//func();
		
		
}
}